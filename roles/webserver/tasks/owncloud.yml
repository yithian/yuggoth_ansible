---
- name: create owncloud mariadb database
  mysql_db:
      name: "{{ oc_dbname }}"
      state: present
  tags:
      - owncloud
      - database

- name: create owncloud mariadb user
  mysql_user:
      name: "{{ oc_dbuser }}"
      password: "{{ oc_dbpassword }}"
      priv: "{{ oc_dbname }}.*:ALL"
      state: present
  tags:
      - owncloud
      - database

- name: mount owncloud storage
  mount:
      src: "{{ storage_host }}:{{ oc_volume }}"
      name: "{{ oc_mountpoint }}"
      fstype: nfs
      opts: _netdev,vers=3
      dump: 0
      passno: 0
      state: mounted
  tags:
      - owncloud
      - storage

- name: ensure httpd systemd override directory exists
  file:
      path: /etc/systemd/system/httpd.service.d
      owner: root
      group: root
      mode: 0755
      state: directory
  notify: reload systemd
  tags:
      - owncloud

- name: land httpd systemd override
  template:
      src: templates/httpd/override.conf.j2
      dest: /etc/systemd/system/httpd.service.d/override.conf
      owner: root
      group: root
      mode: 0644
  tags:
      - owncloud

- name: install owncloud
  pacman:
      name: "{{ item }}"
      state: installed
  with_items:
      - owncloud
      - owncloud-app-bookmarks
      - owncloud-app-calendar
      - owncloud-app-contacts
      - owncloud-app-documents
  notify: restart httpd
  tags:
      - owncloud

- name: configure owncloud
  template:
      src: templates/owncloud/config.php.j2
      dest: /etc/webapps/owncloud/config/config.php
      owner: http
      group: http
      mode: 0640
  become_user: http
  notify: restart httpd
  tags:
      - owncloud

- name: cron owncloud's cron.php
  cron:
      name: owncloud cron.php
      user: http
      minute: "*/15"
      job: php -f /usr/share/webapps/owncloud/cron.php > /dev/null 2>&1
      state: present
  tags:
      - owncloud
      - cron

- name: configure owncloud httpd virtual host
  template:
      src: templates/httpd/extra/owncloud.conf.j2
      dest: /etc/httpd/conf/extra/owncloud.conf
      owner: root
      group: root
      mode: 0644
  notify: reload httpd
  tags:
      - owncloud
      - httpd
