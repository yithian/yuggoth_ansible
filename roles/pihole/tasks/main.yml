---
- name: pull pihole docker image
  docker_image:
    name: pihole/pihole:latest
    source: pull
    state: present
  tags:
    - pihole
    - docker

- name: create pihole persistent storage
  docker_volume:
    name: "{{ item }}"
    state: present
  with_items:
    - pihole_etc
    - pihole_dnsmasq
  tags:
    - pihole
    - docker

- name: mount nfs for pihole etc
  mount:
    src: "{{ storage_host }}:{{ pihole_etc_volume }}"
    name: "{{ pihole_etc_mountpoint }}"
    fstype: nfs
    opts: vers=3,comment=systemd.automount
    dump: 0
    passno: 0
    state: mounted
  tags:
    - docker
    - pihole

- name: mount nfs for pihole dnsmasq
  mount:
    src: "{{ storage_host }}:{{ pihole_dnsmasq_volume }}"
    name: "{{ pihole_dnsmasq_mountpoint }}"
    fstype: nfs
    opts: vers=3,comment=systemd.automount
    dump: 0
    passno: 0
    state: mounted
  tags:
    - docker
    - pihole

#- name: ensure systemd-resolved is not running
#  systemd:
#    name: systemd-resolved
#    state: stopped
#    enabled: no

- name: create a pihole container
  docker_container:
    name: pihole
    image: pihole/pihole:latest
    state: started
    restart_policy: always
    published_ports:
      #- "53:53/tcp"
      #- "53:53/udp"
      #- "67:67/udp"
      - "8080:80/tcp"
    env:
      TZ: "America/New_York"
      # opendns upstream
      PIHOLE_DNS_: 208.67.222.222;208.67.220.220
      PIHOLE_DOMAIN: pihole.yuggoth.space
      VIRTUAL_HOST:  pihole.yuggoth.space
    volumes:
      - "{{ pihole_etc_volume }}:/etc/pihole/"
      - "{{ pihole_dnsmasq_volume }}:/etc/dnsmasq.d/"
    restart_policy: unless-stopped
    dns_servers:
      - 127.0.0.1
      - 208.67.222.222
  tags:
    - pihole
    - container
